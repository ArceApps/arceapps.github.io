---
import "@fontsource/inter/300.css";
import "@fontsource/inter/400.css";
import "@fontsource/inter/500.css";
import "@fontsource/inter/700.css";
import "@fontsource/material-icons";
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { ClientRouter } from "astro:transitions";

interface Props {
  title: string;
  description?: string;
  image?: string;
  type?: "website" | "article" | "profile";
  publishDate?: Date;
  author?: string;
}

const {
  title,
  description = "ArceApps - Aplicaciones Android de calidad, modernas y funcionales.",
  image = "/images/default-og.png",
  type = "website",
  publishDate,
  author = "ArceApps",
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = new URL(image, Astro.url);
---

<!doctype html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/logo.png" />
    <link rel="apple-touch-icon" href="/logo.png" />
    <link rel="canonical" href={canonicalURL} />
    <meta name="generator" content={Astro.generator} />
    <ClientRouter />

    <!-- Security Headers -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta
      http-equiv="Content-Security-Policy"
      content="upgrade-insecure-requests"
    />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={socialImageURL} />

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#018786" />

    <!-- Performance Optimizations -->
    <link rel="preconnect" href="https://play-lh.googleusercontent.com" />

    <!-- Google Analytics -->
    <script
      type="text/partytown"
      src="https://www.googletagmanager.com/gtag/js?id=G-CZLNYSWY76"></script>
    <script type="text/partytown">
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-CZLNYSWY76");
    </script>

    <!-- Schema.org -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": type === "article" ? "BlogPosting" : "WebSite",
        url: Astro.url,
        name: title,
        description: description,
        image: socialImageURL,
        author: {
          "@type": "Person",
          name: author,
          url: "https://arceapps.com/about-me",
        },
        ...(publishDate && {
          datePublished: publishDate.toISOString(),
          dateModified: publishDate.toISOString(),
        }),
      }).replace(/</g, "\\u003C")}
    />

    <script is:inline>
      // Theme Script
      function getTheme() {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          return "dark";
        }
        return "light";
      }

      function applyTheme(doc) {
        const theme = getTheme();
        if (theme === "dark") {
          doc.documentElement.classList.add("dark");
        } else {
          doc.documentElement.classList.remove("dark");
        }
        // Ensure localStorage is synced (optional but good for consistency)
        if (typeof localStorage !== "undefined") {
          localStorage.setItem("theme", theme);
        }
      }

      // Initial load
      applyTheme(document);

      // View Transitions: Apply theme to new document BEFORE swap to prevent FOUC
      document.addEventListener("astro:before-swap", (ev) => {
        applyTheme(ev.newDocument);
      });
    </script>
  </head>
  <body class="flex flex-col min-h-screen">
    <!-- Scroll Sentinel -->
    <div
      id="scroll-sentinel"
      class="absolute top-0 w-full h-[300px] pointer-events-none -z-50"
      aria-hidden="true"
    >
    </div>

    <a
      href="#main-content"
      class="fixed top-4 left-4 z-[100] -translate-y-[150%] bg-primary text-white px-4 py-2 rounded-lg shadow-lg font-bold focus:translate-y-0 transition-transform duration-300 focus:outline-none focus:ring-4 focus:ring-white/50"
    >
      Saltar al contenido principal
    </a>
    <Header />
    <main id="main-content" class="flex-grow">
      <slot />
    </main>
    <Footer />
    <!-- Scroll to Top Button -->
    <button
      id="scroll-to-top"
      aria-label="Volver arriba"
      class="fixed bottom-8 right-8 z-50 bg-primary text-white w-12 h-12 rounded-full shadow-lg elevation-4 flex items-center justify-center translate-y-20 opacity-0 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-primary/50 hover:bg-primary-dark hover:scale-110 pointer-events-none"
    >
      <span class="material-icons">arrow_upward</span>
    </button>

    <script>
      function initLayout() {
        // Scroll to Top Logic
        const scrollBtn = document.getElementById("scroll-to-top");
        const scrollSentinel = document.getElementById("scroll-sentinel");

        if (scrollBtn && scrollSentinel) {
          const scrollObserver = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                if (!entry.isIntersecting) {
                  scrollBtn.classList.remove(
                    "translate-y-20",
                    "opacity-0",
                    "pointer-events-none",
                  );
                  scrollBtn.classList.add(
                    "translate-y-0",
                    "opacity-100",
                    "pointer-events-auto",
                  );
                } else {
                  scrollBtn.classList.add(
                    "translate-y-20",
                    "opacity-0",
                    "pointer-events-none",
                  );
                  scrollBtn.classList.remove(
                    "translate-y-0",
                    "opacity-100",
                    "pointer-events-auto",
                  );
                }
              });
            },
            { root: null, threshold: 0 },
          );

          scrollObserver.observe(scrollSentinel);

          scrollBtn.addEventListener("click", () => {
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
        }

        // Intersection Observer for Fade-in Animations
        const observerOptions = {
          root: null,
          rootMargin: "0px",
          threshold: 0.1,
        };

        const observer = new IntersectionObserver((entries, observer) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("is-visible");
              observer.unobserve(entry.target);
            }
          });
        }, observerOptions);

        const fadeElements = document.querySelectorAll(".fade-in-section");
        fadeElements.forEach((el) => observer.observe(el));
      }

      function initServiceWorker() {
        // Service Worker Registration
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker
            .register("/sw.js")
            .then((registration) => {
              console.log("SW registered: ", registration);
            })
            .catch((registrationError) => {
              console.log("SW registration failed: ", registrationError);
            });
        }
      }

      // Initial load
      window.addEventListener("load", initServiceWorker);

      // View Transitions load (fires on initial load too)
      document.addEventListener("astro:page-load", initLayout);
    </script>
  </body>
</html>

---
import { Image } from "astro:assets";
import brandIcon from "../assets/brand-icon.png";
import Search from "./Search.astro";

const navItems = [
  { label: "Inicio", href: "/" },
  { label: "Apps", href: "/apps" },
  { label: "Blog", href: "/blog" },
  { label: "BitÃ¡cora", href: "/devlog" },
  { label: "About Me", href: "/about-me" },
];

const { pathname } = Astro.url;
const normalize = (path: string) => path.replace(/\/$/, "") || "/";
const currentPath = normalize(pathname);

const isActive = (href: string) => {
  if (href === "/") return currentPath === "/";
  return currentPath.startsWith(href);
};
---

<header
  class="sticky top-0 z-50 bg-surface/90 dark:bg-dark-surface/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 transition-colors duration-300"
>
  <div class="container mx-auto px-4 h-16 flex items-center justify-between">
    <!-- Logo -->
    <a
      href="/"
      class="flex items-center gap-2 group focus-visible:ring-2 focus-visible:ring-primary focus-visible:outline-none rounded-lg p-1"
    >
      <Image
        src={brandIcon}
        alt="ArceApps Logo"
        width={40}
        height={40}
        loading="eager"
        fetchpriority="high"
        class="w-10 h-10 rounded-full shadow-md group-hover:scale-105 transition-transform"
      />
      <span
        class="text-xl font-bold tracking-tight text-on-surface dark:text-dark-on-surface"
      >
        Arce<span class="text-primary">Apps</span>
      </span>
    </a>

    <!-- Desktop Nav -->
    <nav class="hidden md:flex items-center gap-8">
      {
        navItems.map((item) => {
          const active = isActive(item.href);
          return (
            <a
              href={item.href}
              aria-current={active ? "page" : undefined}
              class:list={[
                "text-sm font-medium transition-colors focus-visible:ring-2 focus-visible:ring-primary focus-visible:outline-none rounded px-2 py-1",
                active
                  ? "text-primary font-bold"
                  : "text-on-surface-variant dark:text-dark-on-surface-variant hover:text-primary dark:hover:text-primary",
              ]}
            >
              {item.label}
            </a>
          );
        })
      }
    </nav>

    <!-- Actions -->
    <div class="flex items-center gap-2">
      <!-- Search -->
      <Search />

      <!-- Theme Toggle -->
      <button
        id="theme-toggle"
        class="relative w-10 h-10 rounded-full flex items-center justify-center text-on-surface-variant dark:text-dark-on-surface-variant hover:bg-surface-variant dark:hover:bg-gray-800 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary overflow-hidden"
        aria-label="Cambiar tema"
      >
        <div class="relative w-6 h-6">
          <!-- Moon Icon (Visible in Light Mode -> Action: Go Dark) -->
          <span
            id="icon-dark"
            class="material-icons absolute inset-0 text-xl transform transition-all duration-500 rotate-0 scale-100 opacity-100 dark:-rotate-90 dark:scale-0 dark:opacity-0"
          >
            dark_mode
          </span>
          <!-- Sun Icon (Visible in Dark Mode -> Action: Go Light) -->
          <span
            id="icon-light"
            class="material-icons absolute inset-0 text-xl transform transition-all duration-500 rotate-90 scale-0 opacity-0 dark:rotate-0 dark:scale-100 dark:opacity-100"
          >
            light_mode
          </span>
        </div>
      </button>

      <!-- Mobile Menu Button -->
      <button
        id="menu-toggle"
        class="md:hidden w-10 h-10 rounded-full flex items-center justify-center text-on-surface-variant dark:text-dark-on-surface-variant hover:bg-surface-variant dark:hover:bg-gray-800 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-primary"
        aria-label="Menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <span class="material-icons text-2xl">menu</span>
      </button>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="hidden md:hidden border-t border-gray-200 dark:border-gray-800 bg-surface dark:bg-dark-surface absolute w-full shadow-lg"
  >
    <nav class="flex flex-col p-4">
      {
        navItems.map((item) => {
          const active = isActive(item.href);
          return (
            <a
              href={item.href}
              aria-current={active ? "page" : undefined}
              class:list={[
                "py-3 px-4 text-base font-medium rounded-lg transition-colors focus-visible:ring-2 focus-visible:ring-primary focus-visible:outline-none",
                active
                  ? "text-primary bg-primary/10 dark:bg-primary/5"
                  : "text-on-surface dark:text-dark-on-surface hover:bg-surface-variant dark:hover:bg-gray-800",
              ]}
            >
              {item.label}
            </a>
          );
        })
      }
    </nav>
  </div>
</header>

<script>
  let cleanup: (() => void) | undefined;

  function initHeader() {
    if (cleanup) cleanup();

    // Theme Toggle Logic
    const themeToggle = document.getElementById("theme-toggle");

    const handleThemeToggle = () => {
      const element = document.documentElement;
      element.classList.toggle("dark");

      const isDark = element.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    };

    themeToggle?.addEventListener("click", handleThemeToggle);

    // Mobile Menu Logic
    const menuToggle = document.getElementById("menu-toggle");
    const mobileMenu = document.getElementById("mobile-menu");

    let cleanupMenuListeners: (() => void) | undefined;
    let handleLinkClick: (() => void) | undefined;
    let toggleMenu: ((e: Event) => void) | undefined;

    if (menuToggle && mobileMenu) {
      const closeMenu = () => {
        mobileMenu.classList.add("hidden");
        menuToggle.setAttribute("aria-expanded", "false");
        const icon = menuToggle.querySelector(".material-icons");
        if (icon) icon.textContent = "menu";

        if (cleanupMenuListeners) {
          cleanupMenuListeners();
          cleanupMenuListeners = undefined;
        }
      };

      const openMenu = () => {
        mobileMenu.classList.remove("hidden");
        menuToggle.setAttribute("aria-expanded", "true");
        const icon = menuToggle.querySelector(".material-icons");
        if (icon) icon.textContent = "close";

        // Add close-on interaction listeners
        const handleOutsideClick = (e: MouseEvent) => {
          if (
            !mobileMenu.contains(e.target as Node) &&
            !menuToggle.contains(e.target as Node)
          ) {
            closeMenu();
          }
        };

        const handleEscape = (e: KeyboardEvent) => {
          if (e.key === "Escape") closeMenu();
        };

        // Use requestAnimationFrame to avoid immediate trigger from the toggle click
        requestAnimationFrame(() => {
          document.addEventListener("click", handleOutsideClick);
          document.addEventListener("keydown", handleEscape);
        });

        cleanupMenuListeners = () => {
          document.removeEventListener("click", handleOutsideClick);
          document.removeEventListener("keydown", handleEscape);
        };
      };

      toggleMenu = (e: Event) => {
        e.stopPropagation();
        const isHidden = mobileMenu.classList.contains("hidden");
        if (isHidden) openMenu();
        else closeMenu();
      };

      menuToggle.addEventListener("click", toggleMenu);

      // Close on navigation (link click)
      const menuLinks = mobileMenu.querySelectorAll("a");
      handleLinkClick = () => closeMenu();
      menuLinks.forEach((link) =>
        link.addEventListener("click", handleLinkClick!)
      );
    }

    // Set cleanup for next cycle
    cleanup = () => {
      themeToggle?.removeEventListener("click", handleThemeToggle);

      if (menuToggle && toggleMenu) {
        menuToggle.removeEventListener("click", toggleMenu);
      }
      if (cleanupMenuListeners) cleanupMenuListeners();

      const menuLinks = mobileMenu?.querySelectorAll("a");
      if (menuLinks && handleLinkClick) {
        menuLinks.forEach((link) =>
          link.removeEventListener("click", handleLinkClick!)
        );
      }
    };
  }

  // Run on view transitions (fires on initial load too)
  document.addEventListener("astro:page-load", initHeader);
  document.addEventListener("astro:before-swap", () => cleanup && cleanup());
</script>
